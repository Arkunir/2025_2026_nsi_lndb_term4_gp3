<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mon Compte - BetFoot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Variables et styles partagés (pour la cohérence) */
        :root{
            --red:#E30613;
            --dark:#121212;
            --muted:#6b6b6b;
            --bg:#0f1113;
            --card:#151617;
            --white:#ffffff;
            --gain:#1db954;
            --loss:#ff3b3b;
            --glass: rgba(255,255,255,0.03);
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            background:linear-gradient(180deg,var(--bg),#071014);
            color:var(--white);
            min-height:100vh;
        }
        
        /* Style du header et de la navigation */
        header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:18px 24px;
        }
        .brand{
            display:flex;
            align-items:center;
            gap:12px;
        }
        .logo{
            width:30px;
            height:30px;
            border-radius:4px;
            background:var(--red);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            font-size:14px;
        }
        nav{
            display:flex;
            gap:20px;
        }
        nav a{
            color:var(--white);
            text-decoration:none;
            padding:6px 0;
            position:relative;
        }
        nav a:hover{
            color:var(--red);
        }
        /* Style pour le lien 'Mon compte' actif */
        nav a[href="compte.html"]::after { 
            content: '';
            position: absolute;
            left: 0;
            bottom: -2px;
            width: 100%;
            height: 2px;
            background: var(--red);
        }
        
        /* Styles de mise en page */
        .container{
            max-width:800px;
            margin:20px auto;
            padding:0 24px;
        }
        .card{
            background:var(--card);
            padding:20px;
            border-radius:8px;
            margin-bottom:20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .button{
            background-color: var(--red);
            color: var(--white);
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            margin-top: 10px;
        }
        .button:hover{
            background-color: #c90510;
        }
        .remove-btn{
            background-color: #555;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    
    <header>
        <div class="brand">
            <div class="logo">BF</div>
            <div>
                <div style="font-weight:700">BetFoot</div>
                <div style="font-size:12px;color:var(--muted)">Reproduction Betclic — Version Foot</div>
            </div>
        </div>
        <nav>
            <a href="interface.html">Accueil</a>
            <a href="live.html">Matchs en direct</a>
            <a href="paris.html">Paris</a>
            <a href="resultats.html">Résultats</a>
            <a href="compte.html">Mon compte</a>
        </nav>
    </header>

    <main class="container">
        <div class="card">
            <h2 style="margin-top:0">Mon Compte</h2>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px">
                <div style="font-size:18px;font-weight:600">Solde actuel: <span id="userBalanceDisplay">100</span> crédits</div>
                <button class="button" onclick="addFunds(10)">+ 10 Crédits</button>
            </div>
            
            <h3 style="border-bottom:1px solid var(--glass);padding-bottom:10px; margin-top:30px">Historique des transactions</h3>
            <div id="transactionHistory">
                </div>
        </div>

        <div class="card" style="margin-top:30px; border-left:4px solid var(--red)">
            <h2 style="margin-top:0; color:var(--red)">Panneau d'Administration</h2>

            <div id="adminBox">
                <p>Connectez-vous pour accéder aux outils d'administration.</p>
                <form id="adminLoginForm">
                    <input type="text" id="adminUsername" placeholder="Identifiant" style="padding:8px; border:1px solid #333; background:var(--dark); color:white; border-radius:4px; margin-right:10px;">
                    <input type="password" id="adminPassword" placeholder="Mot de passe" style="padding:8px; border:1px solid #333; background:var(--dark); color:white; border-radius:4px; margin-right:10px;">
                    <button class="button" type="submit">Connexion</button>
                </form>
                <p id="adminMessage" style="margin-top:10px; font-size:12px"></p>
            </div>

            <div id="adminPanel" style="display:none; padding-top:15px">
                <p style="color:var(--gain)">Connecté en tant qu'Administrateur.</p>

                <h3 style="border-bottom:1px solid var(--glass);padding-bottom:10px;">Outils de Solde</h3>
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <button class="button" onclick="resetBalance()">Réinitialiser le Solde Utilisateur</button>
                    <button class="remove-btn" onclick="logoutAdmin()" style="background-color:#555">Déconnexion Admin</button>
                </div>

                <h3 style="border-bottom:1px solid var(--glass);padding-bottom:10px; margin-top:30px">Saisie des Scores Officiels</h3>
                <div id="scoreEntryPanel">
                    </div>
                
                <h3 style="border-bottom:1px solid var(--glass);padding-bottom:10px; margin-top:30px">Gestion des Paris (Suppression)</h3>
                <div id="adminHistory">
                    </div>
            </div>
        </div>

    </main>
    
    <script>
        // Variables globales (stockées dans localStorage)
        let balance = 100;
        let bets = []; // L'historique des mises (betHistory)
        let preds = []; // L'historique des tickets/prédictions (predictions)
        
        // --- Fonctions Utilitaires ---

        function getFormattedDate() {
            return new Date().toLocaleString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Détermine le vainqueur (1=Home, 2=Away, N=Nul)
        function getWinner(scoreH, scoreA) {
            if (scoreH > scoreA) return 1;
            if (scoreA > scoreH) return 2;
            return 'N'; 
        }

        // Trouve la mise originale associée à un ticket (utile pour le paiement)
        function findStake(ticketDate) {
            const b = bets.find(x => x.date === ticketDate);
            return b ? Number(b.stake) : null;
        }

        // --- Logique de Payout et Score ---

        // Met à jour le statut d'un ticket après la saisie d'un score
        function updateTicketStatus(ticket) {
            const allMatchesScored = ticket.predictions.every(m => m.realHome !== undefined);
            if (!allMatchesScored) return; // Ne rien faire si tous les matchs ne sont pas scorés

            let ticketStatus = 'win';
            let totalGain = ticket.potential; 
            let hasRefundable = false;

            // 1. Déterminer le statut de chaque match et le statut global du ticket
            for (const match of ticket.predictions) {
                if (match.realHome === undefined) continue; // Si non scoré, ignorer

                let matchStatus = '';
                
                if (match.realHome === match.predictedHome && match.realAway === match.predictedAway) {
                    matchStatus = 'win'; // Score parfait
                } else {
                    const wPred = getWinner(match.predictedHome, match.predictedAway);
                    const wReal = getWinner(match.realHome, match.realAway);
                    
                    if (wPred === wReal) {
                        matchStatus = 'refund'; // Bon résultat (Gagnant/Nul/Perdant) mais mauvais score
                        hasRefundable = true;
                    } else {
                        matchStatus = 'loss'; // Mauvaise prédiction du résultat
                        ticketStatus = 'loss'; 
                    }
                }
                match.status = matchStatus;
            }
            
            // Si une défaite est trouvée, le ticket est perdant, on sort.
            if (ticketStatus === 'loss') {
                ticket.status = 'loss';
                localStorage.setItem('predictions', JSON.stringify(preds));
                renderAdminScoreEntry();
                return; 
            }

            // Si le statut n'est pas 'loss', il est 'win' ou 'pending' (s'il y a des 'refund' et qu'il n'est pas encore payé)
            if (hasRefundable) {
                // Dans le cas d'un "remboursement/partiel" (refund), 
                // on considère le ticket comme gagnant si c'était une prédiction à score exact qui a échoué.
                // On garde 'win' pour payer le plein potentiel par simplification, 
                // car le calcul de la cote partielle est trop complexe à intégrer ici.
                ticketStatus = 'win';
            }


            // 2. Payer si TICKET GAGNANT et PAS ENCORE PAYÉ
            if (ticketStatus === 'win' && !ticket._paid) {
                balance += totalGain;
                localStorage.setItem('userBalance', balance);
                
                // Ajouter une transaction de Gain
                const transaction = {
                    type: 'Gain',
                    amount: totalGain,
                    date: getFormattedDate(),
                    ticket: ticket.date 
                };
                let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                transactions.unshift(transaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                
                ticket._paid = true; // Marquer comme payé
                window.dispatchEvent(new Event('storage')); // Synchroniser le solde
            }
            
            ticket.status = ticketStatus;
            localStorage.setItem('predictions', JSON.stringify(preds));
            
            // Re-render pour voir le statut mis à jour
            renderAdminScoreEntry();
            renderTransactionHistory();
        }

        function saveRealScore(tIndex, mIndex) {
            const t = preds[tIndex];
            const m = t.predictions[mIndex];

            const rH = Number(document.getElementById(`realH_${tIndex}_${mIndex}`).value);
            const rA = Number(document.getElementById(`realA_${tIndex}_${mIndex}`).value);

            if (isNaN(rH) || isNaN(rA) || rH < 0 || rA < 0) {
                alert("Entrez un score valide (chiffre positif ou zéro).");
                return;
            }

            m.realHome = rH;
            m.realAway = rA;
            m.scored = true; 

            // Lancer la vérification et le paiement pour le ticket entier
            updateTicketStatus(t); 

            alert(`Score (${rH}-${rA}) enregistré pour ${m.home} vs ${m.away}. Le ticket a été mis à jour.`);
        }
        
        // --- Fonctions d'Affichage Admin ---

        function renderAdminScoreEntry() {
            const container = document.getElementById('scoreEntryPanel');
            if (!container) return;
            
            // Afficher seulement les tickets qui ne sont pas encore payés
            const pendingTickets = preds.filter(t => !t._paid); 

            if (pendingTickets.length === 0) {
                container.innerHTML = '<div style="color:var(--gain); font-weight:600">Tous les tickets ont été validés et payés.</div>';
                return;
            }

            container.innerHTML = pendingTickets.map((t, tIndex) => {
                // Trouver la mise et le potentiel du ticket
                const originalBet = bets.find(b => b.date === t.date);
                const stake = originalBet ? originalBet.stake : 'N/A';
                const potential = originalBet ? originalBet.potential : 'N/A';
                
                const matchesHtml = t.predictions.map((m, mIndex) => {
                    const isScored = m.scored || (m.realHome !== undefined && m.realAway !== undefined);
                    
                    let scoreInput = '';
                    if (t.status === 'loss' || t._paid) {
                        // Afficher le score final si le ticket est déjà résolu (perdu ou payé)
                        scoreInput = `Score Final: ${m.realHome || '?'} - ${m.realAway || '?'}`;
                    } else {
                         // Afficher les champs de saisie
                        scoreInput = `
                            <input type="number" id="realH_${tIndex}_${mIndex}" value="${m.realHome !== undefined ? m.realHome : ''}" min="0" max="99" style="width:40px; padding:5px; margin-right:5px; border:1px solid #333; background:var(--dark); color:white; border-radius:4px;">
                            - 
                            <input type="number" id="realA_${tIndex}_${mIndex}" value="${m.realAway !== undefined ? m.realAway : ''}" min="0" max="99" style="width:40px; padding:5px; margin-left:5px; border:1px solid #333; background:var(--dark); color:white; border-radius:4px;">
                            <button class="button" onclick="saveRealScore(${tIndex}, ${mIndex})" style="margin-left:10px; padding:5px 10px; margin-top:0; font-size:12px">Valider Score</button>
                          `;
                    }
                          
                    const statusText = m.status === 'win' ? '✅ Score Exact' : (m.status === 'loss' ? '❌ Perdu' : (m.status === 'refund' ? '⚠️ Résultat Correct (Score Faux)' : '... En attente'));
                    const statusColor = m.status === 'win' ? 'var(--gain)' : (m.status === 'loss' ? 'var(--red)' : 'orange');

                    return `
                        <div style="padding:8px 0; border-bottom:1px dashed var(--glass); margin-bottom:10px">
                            <div style="font-size:14px; font-weight:600">${m.home} vs ${m.away}</div>
                            <div style="font-size:12px; color:var(--muted)">Prédiction: ${m.predictedHome}-${m.predictedAway} @ ${m.odd}</div>
                            
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
                                <div style="font-size:12px; color:var(--muted)">Score Officiel:</div>
                                <div>${scoreInput}</div>
                            </div>
                            ${isScored ? `<div style="font-size:12px; margin-top:4px; color:${statusColor}">Statut du match: ${statusText}</div>` : ''}
                        </div>
                    `;
                }).join('');

                const ticketStatusText = t.status === 'win' ? `✅ Ticket Gagnant (+${potential} crédits)` : (t.status === 'loss' ? '❌ Ticket Perdant' : '⏳ En attente');
                const ticketStatusColor = t.status === 'win' ? 'var(--gain)' : (t.status === 'loss' ? 'var(--red)' : 'var(--white)');

                return `
                    <div class="card" style="border:1px solid var(--glass); margin-top:15px; background:var(--dark); padding:15px">
                        <div style="font-size:16px; font-weight:700; margin-bottom:10px">Ticket du ${t.date}</div>
                        <div style="font-size:13px; color:var(--muted); margin-bottom:10px">Mise: ${stake} — Potentiel: ${potential}</div>
                        <div style="font-weight:600; color:${ticketStatusColor}; margin-bottom:15px">${ticketStatusText}</div>
                        ${matchesHtml}
                    </div>
                `;
            }).join('');
        }

        // --- Fonctions d'Administration et de Gestion du Compte (Admin/User) ---
        
        // Ajout de fonds (pour l'utilisateur)
        function addFunds(amount) {
            balance += amount;
            localStorage.setItem('userBalance', balance);
            
            // Ajouter une transaction fictive
            const newTransaction = {
                type: 'Crédit',
                amount: amount,
                date: getFormattedDate()
            };
            let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            transactions.unshift(newTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));

            document.getElementById('userBalanceDisplay').textContent = balance;
            renderTransactionHistory();
            
            window.dispatchEvent(new Event('storage'));
        }

        // Afficher l'historique des transactions utilisateur
        function renderTransactionHistory() {
            const container = document.getElementById('transactionHistory');
            let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            
            if(transactions.length === 0) {
                container.innerHTML = '<div style="color:var(--muted);font-size:13px">Aucune transaction enregistrée.</div>';
                return;
            }

            container.innerHTML = transactions.map(t => {
                let amountDisplay = `+ ${t.amount} crédits`;
                let color = 'var(--gain)';
                if (t.type === 'Gain') {
                    amountDisplay = `+ ${t.amount} crédits`;
                    color = 'var(--gain)';
                } else if (t.type === 'Crédit') {
                    amountDisplay = `+ ${t.amount} crédits`;
                    color = 'var(--white)';
                } else if (t.type === 'Pari') {
                    amountDisplay = `- ${t.amount} crédits`;
                    color = 'var(--loss)';
                } else if (t.type === 'Réinitialisation') {
                    amountDisplay = t.amount;
                    color = 'orange';
                }

                return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--glass)">
                            <div style="font-size:13px;color:var(--muted)">${t.date}</div>
                            <div>${t.type}</div>
                            <div style="font-weight:700; color:${color}">${amountDisplay}</div>
                        </div>`;
            }).join('');
        }
        
        // Connexion Admin
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const user = document.getElementById('adminUsername').value;
            const pass = document.getElementById('adminPassword').value;
            const msg = document.getElementById('adminMessage');

            // Identifiants factices pour la démo
            if (user === 'admin' && pass === '1234') {
                document.getElementById('adminBox').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                msg.style.color = "var(--gain)";
                msg.textContent = "Connexion réussie !";
                renderAdminScoreEntry(); // Afficher la saisie des scores
                renderAdminHistory(); // Afficher l'historique de suppression
            } else {
                msg.style.color = "var(--red)";
                msg.textContent = "Identifiant ou mot de passe incorrect.";
            }
        });
        
        // Déconnexion Admin
        function logoutAdmin(){
            document.getElementById('adminBox').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminMessage').textContent = '';
        }

        // Réinitialisation du solde
        function resetBalance(){
            balance = 100; // Remet le solde à la valeur par défaut
            localStorage.setItem('userBalance', balance);
            document.getElementById('userBalanceDisplay').textContent = balance;

            // Ajouter une transaction fictive de réinitialisation
            let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const resetTransaction = {
                type: 'Réinitialisation',
                amount: 'au 100', // Texte pour la réinitialisation
                date: getFormattedDate()
            };
            transactions.unshift(resetTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderTransactionHistory();
            
            window.dispatchEvent(new Event('storage'));
            alert("Le solde utilisateur a été réinitialisé à 100 crédits.");
        }

        // Supprimer un pari
        function removeBet(index){
            bets.splice(index, 1);
            localStorage.setItem('betHistory', JSON.stringify(bets));
            renderAdminHistory();
            alert("Pari supprimé de l'historique.");
            window.dispatchEvent(new Event('storage')); 
        }

        // Historique admin (avec suppression)
        function renderAdminHistory(){
            const container = document.getElementById('adminHistory');
            // Récupérer l'historique mis à jour
            bets = JSON.parse(localStorage.getItem('betHistory') || '[]');

            if(bets.length===0){
                container.innerHTML = '<div style="color:var(--muted)">Aucun pari effectué</div>';
                return;
            }
            container.innerHTML = bets.map((h, idx)=>{
                const sel = h.selections.map(s=>`${s.home} vs ${s.away} (${s.odd})`).join('<br>');
                return `<div style="border-bottom:1px solid var(--glass); padding:10px 0; margin-bottom:10px">
                            <div style="font-size:13px;color:var(--muted)">${h.date}</div>
                            <div style="font-weight:600">Mise: ${h.stake} crédits — Potentiel: ${h.potential} crédits</div>
                            <div style="font-size:13px; margin-top:4px; margin-bottom:8px">${sel}</div>
                            <button class="remove-btn" onclick="removeBet(${idx})">Supprimer ce pari</button>
                        </div>`;
            }).join('');
        }

        // --- Initialisation et Synchronisation ---

        document.addEventListener('DOMContentLoaded', ()=>{
            // Charger le solde
            const storedBalance = localStorage.getItem('userBalance');
            if(storedBalance !== null){
                balance = Number(storedBalance);
            }
            document.getElementById('userBalanceDisplay').textContent = balance;
            
            // Charger les paris (pour l'admin)
            bets = JSON.parse(localStorage.getItem('betHistory') || '[]');
            // Charger les tickets de prédictions (pour la saisie des scores)
            preds = JSON.parse(localStorage.getItem('predictions') || '[]');

            // Afficher l'historique des transactions utilisateur
            renderTransactionHistory();
        });

        // Garder le solde et les données en synchronisation si changés sur une autre page
        window.addEventListener('storage', (e)=>{
            if(e.key === 'userBalance' && e.newValue !== null){
                balance = Number(e.newValue);
                document.getElementById('userBalanceDisplay').textContent = balance;
            }
            if(e.key === 'betHistory'){
                bets = JSON.parse(localStorage.getItem('betHistory') || '[]');
                if(document.getElementById('adminPanel').style.display === 'block'){
                    renderAdminHistory();
                }
            }
            if(e.key === 'predictions'){
                preds = JSON.parse(localStorage.getItem('predictions') || '[]');
                if(document.getElementById('adminPanel').style.display === 'block'){
                    renderAdminScoreEntry();
                }
            }
            if(e.key === 'transactions' || e.key === 'userBalance'){
                 renderTransactionHistory();
            }
        });
    </script>
</body>
</html>